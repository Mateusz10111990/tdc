box: node

build:
  # Read more about steps on our dev center:
  # http://devcenter.wercker.com/docs/steps/index.html
  steps:
    # A step that executes `npm install` command
    - npm-install
    - script:
        name: Building Angular sources
        code: |
          echo "OK"
          #cd angular-src
          #npm install -g @angular/cli@latest
          #npm install
          #ng build

 build-appcontainer:
  steps:
    - script:
      name: install zip
      code: |
        sudo apt-get update -y
        sudo apt-get upgrade -y
        sudo apt-get install -y zip
    - script:
        name: Create ACCS zip
        code: |
          mkdir target
          zip -r target/tdc.zip config.js package.json public routes server.js manifest.json

push:
  steps:
    # Push to public docker repo
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        tag: latest
        repository: $DOCKER_REPOSITORY
        registry: https://index.docker.io/v1/
        cmd: npm start

deploy-accs:
  steps:
    # Deploy to Oracle Application Container Cloud
    - peternagy/oracle-accs-deploy@1.0.1:
        opc_user: $OPC_USERNAME
        opc_password: $OPC_PASSWORD
        rest_url: $REST_URL
        domain: $IDENTITY_DOMAIN
        application_name: tdcDemo1
        application_type: node
        file: tdc.zip

restart-occs:
  steps:
    # Manage Oracle Container Cloud Service container
    - peternagy/oracle-occs-container-util:
        occs_user: $OCCS_USER
        occs_password: $OCCS_PASSWORD
        rest_server_url: $REST_SERVER_URL
        function: $FUNCTION
        deployment_name: $DEPLOYMENT_NAME

